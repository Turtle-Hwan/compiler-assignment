<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mini-JS Compiler</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            color: #e0e0e0;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            text-align: center;
            padding: 30px 0;
        }

        h1 {
            font-size: 2.5em;
            color: #f0d000;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
            margin-bottom: 10px;
        }

        .subtitle {
            color: #a0a0a0;
            font-size: 1.1em;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        @media (max-width: 900px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }

        .panel {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .panel-title {
            font-size: 1.2em;
            color: #f0d000;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, #f0d000 0%, #e6b800 100%);
            color: #1a1a2e;
            font-weight: bold;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(240, 208, 0, 0.4);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: #e0e0e0;
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        textarea, .output-area {
            width: 100%;
            font-family: 'Monaco', 'Consolas', 'Courier New', monospace;
            font-size: 14px;
            background: #0d1117;
            color: #c9d1d9;
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 15px;
            resize: vertical;
        }

        textarea {
            min-height: 300px;
        }

        .output-area {
            min-height: 300px;
            max-height: 500px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .output-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .tab-btn {
            padding: 8px 16px;
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            color: #a0a0a0;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .tab-btn.active {
            background: rgba(240, 208, 0, 0.2);
            border-color: #f0d000;
            color: #f0d000;
        }

        .tab-btn:hover:not(.active) {
            background: rgba(255, 255, 255, 0.1);
        }

        .examples {
            margin-top: 30px;
        }

        .example-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .example-btn {
            padding: 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: #e0e0e0;
            cursor: pointer;
            text-align: left;
            transition: all 0.3s ease;
        }

        .example-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: #f0d000;
        }

        .example-btn strong {
            display: block;
            color: #f0d000;
            margin-bottom: 5px;
        }

        .loading {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .loading.show {
            display: flex;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-top-color: #f0d000;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        footer {
            text-align: center;
            padding: 30px 0;
            color: #606060;
            font-size: 0.9em;
        }

        .status {
            padding: 10px;
            border-radius: 6px;
            margin-top: 10px;
            font-size: 0.9em;
        }

        .status.success {
            background: rgba(0, 255, 0, 0.1);
            color: #4caf50;
        }

        .status.error {
            background: rgba(255, 0, 0, 0.1);
            color: #f44336;
        }

        /* Syntax highlighting keywords */
        .keyword { color: #ff79c6; }
        .number { color: #bd93f9; }
        .string { color: #f1fa8c; }
        .comment { color: #6272a4; }
    </style>
</head>
<body>
    <div class="loading" id="loading">
        <div class="spinner"></div>
    </div>

    <div class="container">
        <header>
            <h1>Mini-JS Compiler</h1>
            <p class="subtitle">WebAssembly 기반 JavaScript-like 언어 컴파일러</p>
        </header>

        <div class="main-content">
            <div class="panel">
                <div class="panel-header">
                    <span class="panel-title">Mini-JS Code</span>
                    <div>
                        <button class="btn btn-secondary" onclick="clearEditor()">Clear</button>
                        <button class="btn btn-primary" onclick="runCompiler()">Compile & Run</button>
                    </div>
                </div>
                <textarea id="code-editor" placeholder="Enter your Mini-JS code here...">// Test 00: Hello World - String Literals
// Purpose: Test string output with different quote types ("", '', ``)
// Expected output:
//   Hello, World!
//   Single quotes work too
//   Backticks also supported

function main() {
    // Double quotes
    console.log("Hello, World!");

    // Single quotes
    console.log('Single quotes work too');

    // Backticks (template literals style)
    console.log(`Backticks also supported`);

    return 0;
}</textarea>
            </div>

            <div class="panel">
                <div class="panel-header">
                    <span class="panel-title">Output</span>
                </div>
                <div class="output-tabs">
                    <button class="tab-btn active" onclick="showTab('all')" id="tab-all">All</button>
                    <button class="tab-btn" onclick="showTab('ast')" id="tab-ast">AST</button>
                    <button class="tab-btn" onclick="showTab('asm')" id="tab-asm">Assembly</button>
                    <button class="tab-btn" onclick="showTab('exec')" id="tab-exec">Execution</button>
                </div>
                <div class="output-area" id="output">Click "Compile & Run" to see results...</div>
                <div class="status" id="status" style="display: none;"></div>
            </div>
        </div>

        <div class="examples panel">
            <div class="panel-header">
                <span class="panel-title">Example Programs</span>
            </div>
            <div class="example-list">
                <button class="example-btn" onclick="loadExample('hello_string')">
                    <strong>00. Hello World</strong>
                    문자열 출력 테스트
                </button>
                <button class="example-btn" onclick="loadExample('basic_arithmetic')">
                    <strong>01. Arithmetic</strong>
                    +, -, *, /, % 연산
                </button>
                <button class="example-btn" onclick="loadExample('comparison')">
                    <strong>02. Comparison</strong>
                    &lt;, &gt;, &lt;=, &gt;=, ==, !=
                </button>
                <button class="example-btn" onclick="loadExample('logical')">
                    <strong>03. Logical</strong>
                    &amp;&amp;, || 논리 연산
                </button>
                <button class="example-btn" onclick="loadExample('nested_if')">
                    <strong>04. Nested If</strong>
                    중첩 조건문
                </button>
                <button class="example-btn" onclick="loadExample('while_loop')">
                    <strong>05. While Loop</strong>
                    while 반복문
                </button>
                <button class="example-btn" onclick="loadExample('for_loop')">
                    <strong>06. For Loop</strong>
                    for 반복문
                </button>
                <button class="example-btn" onclick="loadExample('multi_func')">
                    <strong>07. Functions</strong>
                    함수 조합
                </button>
                <button class="example-btn" onclick="loadExample('gcd')">
                    <strong>08. GCD</strong>
                    최대공약수 (재귀)
                </button>
                <button class="example-btn" onclick="loadExample('scope')">
                    <strong>09. Scope</strong>
                    변수 스코프
                </button>
                <button class="example-btn" onclick="loadExample('complex_expr')">
                    <strong>10. Expression</strong>
                    연산자 우선순위
                </button>
                <button class="example-btn" onclick="loadExample('fibonacci')">
                    <strong>11. Fibonacci</strong>
                    피보나치 수열
                </button>
                <button class="example-btn" onclick="loadExample('factorial')">
                    <strong>12. Factorial</strong>
                    팩토리얼 (재귀)
                </button>
                <button class="example-btn" onclick="loadExample('sum')">
                    <strong>13. Sum</strong>
                    1~N 합계 (for)
                </button>
                <button class="example-btn" onclick="loadExample('prime')">
                    <strong>14. Prime</strong>
                    소수 판별
                </button>
            </div>
        </div>

        <footer>
            <p>Mini-JS Compiler - Compiler Design Course Project</p>
            <p>Built with Flex, Bison, and WebAssembly</p>
        </footer>
    </div>

    <!-- Emscripten Module 설정 (minijs.js 로드 전에 정의해야 함) -->
    <script>
        var Module = {
            onRuntimeInitialized: function() {
                compileMinijs = Module.cwrap('compile_mini_js', 'string', ['string']);
                compileToAsm = Module.cwrap('compile_to_asm', 'string', ['string']);
                executeMinijs = Module.cwrap('execute_mini_js', 'string', ['string']);
                console.log('WebAssembly module loaded successfully');
            }
        };
    </script>

    <script>
        // Example programs (examples 폴더와 동일)
        const examples = {
            hello_string: `// Test 00: Hello World - String Literals
// Purpose: Test string output with different quote types ("", '', \`\`)
// Expected output:
//   Hello, World!
//   Single quotes work too
//   Backticks also supported

function main() {
    // Double quotes
    console.log("Hello, World!");

    // Single quotes
    console.log('Single quotes work too');

    // Backticks (template literals style)
    console.log(\`Backticks also supported\`);

    return 0;
}`,
            basic_arithmetic: `// Test 01: Basic Arithmetic Operations
// Purpose: Test all arithmetic operators (+, -, *, /, %)
// Expected: 15, 5, 50, 2, 0

function main() {
    let a = 10;
    let b = 5;

    // Addition
    console.log(a + b);   // 15

    // Subtraction
    console.log(a - b);   // 5

    // Multiplication
    console.log(a * b);   // 50

    // Division
    console.log(a / b);   // 2

    // Modulo
    console.log(a % b);   // 0

    return 0;
}`,
            comparison: `// Test 02: Comparison Operators
// Purpose: Test all comparison operators (<, >, <=, >=, ==, !=)
// Expected: 1, 0, 1, 0, 1, 1

function main() {
    let x = 10;
    let y = 20;
    let z = 10;

    // Less than
    if (x < y) {
        console.log(1);   // true: 10 < 20
    } else {
        console.log(0);
    }

    // Greater than
    if (x > y) {
        console.log(1);
    } else {
        console.log(0);   // false: 10 > 20
    }

    // Less than or equal
    if (x <= z) {
        console.log(1);   // true: 10 <= 10
    } else {
        console.log(0);
    }

    // Greater than or equal
    if (x >= y) {
        console.log(1);
    } else {
        console.log(0);   // false: 10 >= 20
    }

    // Equal
    if (x == z) {
        console.log(1);   // true: 10 == 10
    } else {
        console.log(0);
    }

    // Not equal
    if (x != y) {
        console.log(1);   // true: 10 != 20
    } else {
        console.log(0);
    }

    return 0;
}`,
            logical: `// Test 03: Logical Operators
// Purpose: Test logical AND (&&) and OR (||) operators
// Expected: 0, 1, 1, 0

function main() {
    let a = 1;  // true
    let b = 0;  // false

    // AND: true && false = false
    if (a && b) {
        console.log(1);
    } else {
        console.log(0);   // 0
    }

    // OR: true || false = true
    if (a || b) {
        console.log(1);   // 1
    } else {
        console.log(0);
    }

    // Complex: (true && true) || false = true
    let c = 1;
    if ((a && c) || b) {
        console.log(1);   // 1
    } else {
        console.log(0);
    }

    // Complex: false && (true || true) = false
    if (b && (a || c)) {
        console.log(1);
    } else {
        console.log(0);   // 0
    }

    return 0;
}`,
            nested_if: `// Test 04: Nested If-Else Statements
// Purpose: Test nested conditional logic
// Expected: 2, 3, 1, 0

function categorize(score) {
    if (score >= 90) {
        return 3;  // excellent
    } else {
        if (score >= 70) {
            return 2;  // medium
        } else {
            if (score >= 50) {
                return 1;  // pass
            } else {
                return 0;  // fail
            }
        }
    }
}

function main() {
    let score = 85;
    let result = categorize(score);
    console.log(result);  // 2 (medium)

    // Test other cases
    console.log(categorize(95));  // 3 (excellent)
    console.log(categorize(65));  // 1 (pass)
    console.log(categorize(40));  // 0 (fail)

    return 0;
}`,
            while_loop: `// Test 05: While Loop
// Purpose: Test while loop with counter and accumulator
// Expected: 55, 5, 4, 3, 2, 1

function main() {
    let sum = 0;
    let i = 1;

    while (i <= 10) {
        sum = sum + i;
        i = i + 1;
    }

    console.log(sum);  // 55

    // Test countdown
    let count = 5;
    while (count > 0) {
        console.log(count);  // 5, 4, 3, 2, 1
        count = count - 1;
    }

    return 0;
}`,
            for_loop: `// Test 06: For Loop
// Purpose: Test for loop with different patterns
// Expected: 14, 0, 2, 4, 6, 8, 10

function square(x) {
    return x * x;
}

function main() {
    // Sum of squares: 1^2 + 2^2 + 3^2 = 1 + 4 + 9 = 14
    let sum = 0;
    for (let i = 1; i <= 3; i = i + 1) {
        sum = sum + square(i);
    }
    console.log(sum);  // 14

    // Counting by 2s
    for (let j = 0; j <= 10; j = j + 2) {
        console.log(j);  // 0, 2, 4, 6, 8, 10
    }

    return 0;
}`,
            multi_func: `// Test 07: Multiple Functions and Function Composition
// Purpose: Test multiple function definitions and calling between functions
// Expected: 25 (5^2), 125 (5^3), 625 (5^4)

function square(x) {
    return x * x;
}

function cube(x) {
    return x * square(x);  // Uses square function
}

function power4(x) {
    return square(square(x));  // Composition: (x^2)^2 = x^4
}

function main() {
    let n = 5;

    console.log(square(n));  // 25
    console.log(cube(n));    // 125
    console.log(power4(n));  // 625

    return 0;
}`,
            gcd: `// Test 08: GCD (Greatest Common Divisor) using Euclidean Algorithm
// Purpose: Test recursive algorithm with modulo operator
// Expected: 6, 25, 1, 12

function gcd(a, b) {
    if (b == 0) {
        return a;
    }
    return gcd(b, a % b);
}

function main() {
    console.log(gcd(48, 18));  // 6
    console.log(gcd(100, 25)); // 25
    console.log(gcd(17, 13));  // 1 (coprime)
    console.log(gcd(36, 24));  // 12

    return 0;
}`,
            scope: `// Test 09: Variable Scope
// Purpose: Test variable scoping in functions and blocks
// Expected: 10, 100, 10, 50

function modifyLocal(x) {
    x = 100;  // Local modification
    return x;
}

function useOuter() {
    let outer = 50;
    return outer;
}

function main() {
    let global = 10;

    console.log(global);  // 10 (original)

    let result = modifyLocal(global);
    console.log(result);  // 100 (returned from function)

    console.log(global);  // 10 (unchanged - pass by value)

    console.log(useOuter());  // 50

    return 0;
}`,
            complex_expr: `// Test 10: Complex Expressions
// Purpose: Test operator precedence and complex expressions
// Expected: 17, 1, 14

function main() {
    // Test operator precedence: * before +
    // 3 + 2 * 7 = 3 + 14 = 17
    let a = 3 + 2 * 7;
    console.log(a);  // 17

    // Division before subtraction
    // 10 / 2 - 4 = 5 - 4 = 1
    let b = 10 / 2 - 4;
    console.log(b);  // 1

    // Complex nested expression
    // (2 + 3) * 4 - 6 = 5 * 4 - 6 = 20 - 6 = 14
    let c = (2 + 3) * 4 - 6;
    console.log(c);  // 14

    return 0;
}`,
            fibonacci: `// Fibonacci Sequence
// Prints first 10 Fibonacci numbers

function fib(n) {
    if (n <= 1) {
        return n;
    }
    return fib(n - 1) + fib(n - 2);
}

function main() {
    let i = 0;
    while (i < 10) {
        console.log(fib(i));
        i = i + 1;
    }
    return 0;
}`,
            factorial: `// Factorial Calculation
// Prints factorial of 1 to 10

function factorial(n) {
    if (n <= 1) {
        return 1;
    }
    return n * factorial(n - 1);
}

function main() {
    let n = 1;
    while (n <= 10) {
        let result = factorial(n);
        console.log(result);
        n = n + 1;
    }
    return 0;
}`,
            sum: `// Sum from 1 to N using for loop

function sumTo(n) {
    let sum = 0;
    for (let i = 1; i <= n; i = i + 1) {
        sum = sum + i;
    }
    return sum;
}

function main() {
    // Sum 1 to 100 = 5050
    let result = sumTo(100);
    console.log(result);
    return result;
}`,
            prime: `// Prime Number Check
// Prints all prime numbers from 2 to 50

function isPrime(n) {
    if (n <= 1) {
        return 0;
    }
    let i = 2;
    while (i * i <= n) {
        if (n % i == 0) {
            return 0;
        }
        i = i + 1;
    }
    return 1;
}

function main() {
    let n = 2;
    while (n <= 50) {
        if (isPrime(n)) {
            console.log(n);
        }
        n = n + 1;
    }
    return 0;
}`
        };

        // Module은 위에서 정의됨 (onRuntimeInitialized 콜백 포함)
        let compileMinijs = null;
        let compileToAsm = null;
        let executeMinijs = null;

        // Store results for tabs
        let lastResults = {
            all: '',
            ast: '',
            asm: '',
            exec: ''
        };

        // Load example
        function loadExample(name) {
            if (examples[name]) {
                document.getElementById('code-editor').value = examples[name];
            }
        }

        // Clear editor
        function clearEditor() {
            document.getElementById('code-editor').value = '';
            document.getElementById('output').textContent = 'Click "Compile & Run" to see results...';
            document.getElementById('status').style.display = 'none';
        }

        // Show tab
        function showTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById('tab-' + tab).classList.add('active');
            document.getElementById('output').textContent = lastResults[tab] || 'No results yet...';
        }

        // Show status
        function showStatus(message, isError = false) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = 'status ' + (isError ? 'error' : 'success');
            status.style.display = 'block';
        }

        // Run compiler
        function runCompiler() {
            const code = document.getElementById('code-editor').value;
            const outputEl = document.getElementById('output');

            if (!code.trim()) {
                showStatus('Please enter some code first.', true);
                return;
            }

            document.getElementById('loading').classList.add('show');

            // Simulate compilation if Wasm not loaded
            setTimeout(() => {
                try {
                    let result;
                    if (compileMinijs) {
                        result = compileMinijs(code);
                    } else {
                        // Fallback: show parsed info
                        result = simulateCompile(code);
                    }

                    lastResults.all = result;

                    // Extract AST, assembly and execution parts
                    const astMatch = result.match(/=== AST ===([\s\S]*?)(?===|$)/);
                    const asmMatch = result.match(/=== x86-64 Assembly ===([\s\S]*?)(?===|$)/);
                    const execMatch = result.match(/=== Execution Result ===([\s\S]*?)(?===|$)/);

                    lastResults.ast = astMatch ? astMatch[1].trim() : '(No AST)';
                    lastResults.asm = asmMatch ? asmMatch[1].trim() : '(No assembly generated)';
                    lastResults.exec = execMatch ? execMatch[1].trim() : '(No execution result)';

                    // 현재 활성 탭에 맞는 결과 표시
                    const activeTab = document.querySelector('.tab-btn.active').id.replace('tab-', '');
                    outputEl.textContent = lastResults[activeTab] || lastResults.all;

                    // 에러 체크: 컴파일러 에러는 "=== Parse Error ===" 또는 "=== Error ===" 형식으로 시작하거나,
                    // 성공 시 항상 포함되는 "=== x86-64 Assembly ===" 섹션이 없으면 에러
                    const isCompilerError = result.startsWith('=== Parse Error') ||
                                           result.startsWith('=== Error') ||
                                           result.startsWith('Error:') ||
                                           !result.includes('=== x86-64 Assembly ===');
                    if (isCompilerError) {
                        showStatus('Compilation failed!', true);
                    } else {
                        showStatus('Compilation successful!');
                    }
                } catch (e) {
                    outputEl.textContent = 'Error: ' + e.message;
                    showStatus('Compilation failed: ' + e.message, true);
                }

                document.getElementById('loading').classList.remove('show');
            }, 100);
        }

        // Simulate compilation (when Wasm not available)
        function simulateCompile(code) {
            let output = '=== Mini-JS Compiler (Simulation Mode) ===\n\n';
            output += 'Note: WebAssembly module not loaded. Showing parsed structure.\n\n';

            // Simple analysis
            const functions = code.match(/function\s+(\w+)/g) || [];
            const variables = code.match(/let\s+(\w+)/g) || [];
            const consoles = code.match(/console\.log/g) || [];

            output += '=== Parsed Structure ===\n';
            output += 'Functions found: ' + functions.length + '\n';
            functions.forEach(f => output += '  - ' + f.replace('function ', '') + '\n');

            output += '\nVariables declared: ' + variables.length + '\n';
            variables.forEach(v => output += '  - ' + v.replace('let ', '') + '\n');

            output += '\nconsole.log calls: ' + consoles.length + '\n';

            output += '\n=== Note ===\n';
            output += 'To see actual compilation results, build the WebAssembly module:\n';
            output += '  make wasm\n';

            return output;
        }

        // Initialize
        // Wasm 초기화는 Module.onRuntimeInitialized 콜백에서 자동으로 처리됨

        // Handle keyboard shortcuts
        document.getElementById('code-editor').addEventListener('keydown', function(e) {
            if (e.key === 'Tab') {
                e.preventDefault();
                const start = this.selectionStart;
                const end = this.selectionEnd;
                this.value = this.value.substring(0, start) + '    ' + this.value.substring(end);
                this.selectionStart = this.selectionEnd = start + 4;
            } else if (e.ctrlKey && e.key === 'Enter') {
                runCompiler();
            }
        });
    </script>

    <!-- Load Wasm module if available -->
    <script src="minijs.js" onerror="console.log('Wasm module not found, using simulation mode')"></script>
</body>
</html>
